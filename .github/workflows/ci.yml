name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    name: ${{ matrix.os }} / ${{ matrix.build_type }}
    runs-on: ${{ matrix.os }}
    permissions:
      contents: read
      checks: write
      pull-requests: write
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        build_type: [Release]

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install clang tools
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format clang-tidy

      - name: Configure
        run: make BUILD_TYPE=${{ matrix.build_type }} configure

      # One combined step for clang-format + clang-tidy + annotations + log
      - name: Code analysis (clang-format + clang-tidy with annotations)
        run: |
          files_all=$(git ls-files '*.c' '*.cpp' '*.h' '*.hpp')
          files_cpp=$(git ls-files '*.c' '*.cpp')

          # Single combined log for everything
          : > analysis.log
          status=0

          echo "=== clang-format check ===" | tee -a analysis.log
          if [ -n "$files_all" ]; then
            for f in $files_all; do
              echo "clang-format: $f" >> analysis.log
              # --dry-run + --Werror -> no changes, but non-zero exit on misformat
              clang-format --dry-run --Werror "$f" >> analysis.log 2>&1 || status=1
            done
          else
            echo "No C/C++ files to format." | tee -a analysis.log
          fi

          echo "" >> analysis.log
          echo "=== clang-tidy analysis ===" | tee -a analysis.log
          if [ -n "$files_cpp" ]; then
            for f in $files_cpp; do
              echo "clang-tidy: $f" >> analysis.log
              clang-tidy "$f" -p build >> analysis.log 2>&1 || status=1
            done
          else
            echo "No C/C++ source files for clang-tidy." | tee -a analysis.log
          fi

          echo "" >> analysis.log
          echo "=== GitHub annotations ===" >> analysis.log

          # Turn both clang-format and clang-tidy diagnostics into GitHub annotations
          while IFS= read -r line; do
            if echo "$line" | grep -qE ":[0-9]+:[0-9]+: warning:"; then
              file=$(echo "$line" | cut -d: -f1)
              row=$(echo "$line" | cut -d: -f2)
              col=$(echo "$line" | cut -d: -f3)
              msg=$(echo "$line" | cut -d: -f5-)
              echo "::warning file=$file,line=$row,col=$col::$msg"
            elif echo "$line" | grep -qE ":[0-9]+:[0-9]+: error:"; then
              file=$(echo "$line" | cut -d: -f1)
              row=$(echo "$line" | cut -d: -f2)
              col=$(echo "$line" | cut -d: -f3)
              msg=$(echo "$line" | cut -d: -f5-)
              echo "::error file=$file,line=$row,col=$col::$msg"
            fi
          done < analysis.log

          exit $status

      - name: Upload analysis log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: code-analysis-${{ matrix.os }}-${{ matrix.build_type }}
          path: analysis.log

      - name: Build
        run: make BUILD_TYPE=${{ matrix.build_type }} build

      - name: Test
        id: test
        env:
          GTEST_COLOR: 1
        run: |
          ctest --test-dir build \
                --output-on-failure \
                -C ${{ matrix.build_type }} \
                --output-junit test-results.xml

      - name: Publish test report
        if: ${{ always() && steps.test.outcome != 'skipped' }}
        uses: dorny/test-reporter@v1
        with:
          name: GoogleTest (${{ matrix.os }} / ${{ matrix.build_type }})
          path: build/test-results.xml
          reporter: java-junit
          fail-on-error: false
